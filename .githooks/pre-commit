#!/bin/bash

echo "üöÄ Running Pre-Commit Hook..."

# Prevent commits on the 'test' branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" == "test" ]; then
    echo "‚ùå Direct commits to the 'test' branch are not allowed. Please use a feature or bugfix branch."
    exit 1
fi

# Run PHP-CS-Fixer in backend (auto-fix)
if [ -d "backend" ]; then
    echo "‚ö° Running PHP-CS-Fixer in backend (auto-fix)..."
    (cd backend && vendor/bin/php-cs-fixer fix .)
    if [ $? -ne 0 ]; then
        echo "‚ùå PHP-CS-Fixer failed to fix all issues."
        exit 1
    fi
    git add backend # Re-add fixed files to the commit
fi

# Get list of changed files
FILTERED_FILES=$(git diff --cached --name-only)

# Run ESLint only on changed JS/TS files
JS_TS_FILES=$(echo "$FILTERED_FILES" | grep -E '\.(js|jsx|ts|tsx)$')

if [ -n "$JS_TS_FILES" ]; then
    echo "‚ö° Running ESLint on changed JavaScript/TypeScript files..."
    (cd frontend && npx eslint --fix $JS_TS_FILES)
    if [ $? -ne 0 ]; then
        echo "‚ùå ESLint failed to fix all issues."
        exit 1
    fi
    git add $JS_TS_FILES

    echo "‚ö° Running TypeScript type check on changed files..."
    (cd frontend && npx tsc --noEmit --pretty $JS_TS_FILES)
    if [ $? -ne 0 ]; then
        echo "‚ùå TypeScript errors found. Please fix them before committing."
        exit 1
    fi
fi

echo "‚úÖ All checks passed! Proceeding with commit."
